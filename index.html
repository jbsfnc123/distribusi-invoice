<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekonsiliasi Invoice V2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }
        
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header-app { margin-bottom: 30px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; }
        .header-app h1 { margin: 0; color: #0f172a; }
        .header-app p { margin: 5px 0 0; color: #64748b; }

        /* GRID SYSTEM */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }

        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e2e8f0; }
        .card h3 { margin-top: 0; font-size: 1rem; color: #334155; text-transform: uppercase; letter-spacing: 0.5px; }

        /* STATUS ALERTS */
        .alert { padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; display: flex; align-items: center; gap: 10px; }
        .alert-loading { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .alert-success { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
        .alert-error { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }

        /* INPUTS & BUTTONS */
        input[type="file"] { width: 100%; padding: 10px; background: #f1f5f9; border-radius: 6px; border: 1px dashed #cbd5e1; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: 0.2s; color: white; display: flex; align-items: center; gap: 8px; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-primary { background: var(--primary); }
        .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
        .btn-success { background: #10b981; }
        .btn-success:hover { background: #059669; }

        /* TABLE */
        .table-wrap { overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th { background: #f8fafc; padding: 12px 16px; text-align: left; font-weight: 600; color: #475569; border-bottom: 2px solid #e2e8f0; white-space: nowrap; }
        td { padding: 10px 16px; border-bottom: 1px solid #f1f5f9; color: #334155; white-space: nowrap; }
        tr:hover { background: #f8fafc; }

        /* BADGES & UTILS */
        .badge { padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; }
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .text-right { text-align: right; font-family: 'Courier New', monospace; font-weight: 600; }
        .text-red { color: #dc2626; }
        .hidden { display: none; }
        
        .manual-upload-box { margin-top: 15px; padding: 15px; background: #fff7ed; border: 1px solid #ffedd5; border-radius: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header-app">
        <h1>üßæ Invoice Reconciliation App</h1>
        <p>Sistem pencocokan otomatis data Supplier (Google Sheet) vs Customer (CSV Local)</p>
    </div>

    <div class="grid">
        <div class="card">
            <h3>1. Data Supplier (Master)</h3>
            <div id="supplier-status" class="alert alert-loading">‚è≥ Menghubungkan ke Server...</div>
            
            <div id="supplier-manual" class="manual-upload-box hidden">
                <strong style="color:#9a3412">‚ö†Ô∏è Koneksi Otomatis Gagal</strong>
                <p style="margin:5px 0 10px; font-size:0.85rem; color:#7c2d12;">Browser memblokir akses langsung. Silakan download file dari Google Sheet Anda, lalu upload di sini:</p>
                <input type="file" id="inputSupplierManual" accept=".csv">
            </div>
        </div>

        <div class="card">
            <h3>2. Data Customer (Upload)</h3>
            <p style="font-size:0.85rem; color:#64748b; margin-bottom:10px;">Upload satu atau banyak file CSV sekaligus.</p>
            <input type="file" id="inputCustomer" multiple accept=".csv">
            <div id="customer-status" class="alert alert-loading hidden"></div>
        </div>
    </div>

    <div class="btn-group">
        <button id="btnProcess" class="btn btn-primary" onclick="processData()" disabled>üöÄ Mulai Pengecekan</button>
        <button id="btnExport" class="btn btn-success hidden" onclick="exportExcel()">üì• Download Excel</button>
    </div>

    <br>

    <div class="table-wrap">
        <table id="resultTable">
            <thead>
                <tr><th style="text-align:center; padding:30px;">Data belum tersedia. Silakan load data supplier & customer.</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script>
    // --- SETUP ---
    // Menggunakan Proxy 'AllOrigins' untuk bypass error CORS pada local html
    const GOOGLE_SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTtimJNf3ToEjLfWVhJlEpVUWLHeiOAxapCI56urCX0neQFteu2xP5I4CpwK1tLQVyG6RedZyuZtzkx/pub?gid=0&single=true&output=csv";
    const PROXY_URL = "https://api.allorigins.win/raw?url=" + encodeURIComponent(GOOGLE_SHEET_URL);

    let supplierData = [];
    let customerData = [];
    let finalResult = [];

    // --- 1. LOAD SUPPLIER (AUTO) ---
    window.onload = function() {
        console.log("Mencoba mengambil data supplier...");
        
        // Coba pakai Proxy dulu (lebih stabil untuk local file)
        Papa.parse(PROXY_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: cleanHeader, // Pembersih header
            complete: function(results) {
                if(results.data && results.data.length > 0) {
                    supplierData = results.data;
                    updateSupplierUI("success", `Data Supplier Terhubung (${supplierData.length} baris)`);
                } else {
                    // Jika data kosong, coba direct URL (backup)
                    fetchDirect();
                }
            },
            error: function(err) {
                console.error("Proxy fetch failed, trying direct...", err);
                fetchDirect();
            }
        });
    };

    function fetchDirect() {
        Papa.parse(GOOGLE_SHEET_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            transformHeader: cleanHeader,
            complete: function(results) {
                if(results.data && results.data.length > 0) {
                    supplierData = results.data;
                    updateSupplierUI("success", `Data Supplier Terhubung (Direct) - ${supplierData.length} baris`);
                } else {
                    updateSupplierUI("error", "Gagal memuat otomatis.");
                }
            },
            error: function() {
                updateSupplierUI("error", "Gagal memuat otomatis. Silakan upload manual.");
            }
        });
    }

    function updateSupplierUI(type, msg) {
        const el = document.getElementById('supplier-status');
        const manualBox = document.getElementById('supplier-manual');
        
        if (type === 'success') {
            el.className = 'alert alert-success';
            el.innerHTML = "‚úÖ " + msg;
            manualBox.classList.add('hidden');
            checkReady();
        } else {
            el.className = 'alert alert-error';
            el.innerHTML = "‚ùå " + msg;
            manualBox.classList.remove('hidden'); // Tampilkan tombol upload manual
        }
    }

    // --- 2. LOAD SUPPLIER (MANUAL BACKUP) ---
    document.getElementById('inputSupplierManual').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(!file) return;
        
        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: cleanHeader,
            complete: function(results) {
                supplierData = results.data;
                updateSupplierUI("success", `Data Manual Terupload (${supplierData.length} baris)`);
            }
        });
    });

    // --- 3. LOAD CUSTOMER ---
    document.getElementById('inputCustomer').addEventListener('change', function(e) {
        const files = e.target.files;
        if(files.length === 0) return;

        customerData = [];
        let processedCount = 0;
        const statusEl = document.getElementById('customer-status');
        statusEl.className = 'alert alert-loading';
        statusEl.classList.remove('hidden');
        statusEl.innerText = "Memproses file...";

        Array.from(files).forEach(file => {
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                delimiter: ";", // Sesuai request (titik koma)
                transformHeader: cleanHeader, // Bersihkan header dari quotes/spasi/html
                complete: function(results) {
                    customerData = customerData.concat(results.data);
                    processedCount++;
                    
                    if(processedCount === files.length) {
                        statusEl.className = 'alert alert-success';
                        statusEl.innerHTML = `‚úÖ <b>${processedCount} File</b> Customer digabung (${customerData.length} baris)`;
                        checkReady();
                    }
                }
            });
        });
    });

    // --- UTILS ---
    function cleanHeader(h) {
        // Hapus tanda kutip ("), tanda petik ('), spasi berlebih, dan tag HTML sisa (</)
        return h.replace(/["']/g, "").replace("</", "").trim();
    }

    function checkReady() {
        if(supplierData.length > 0 && customerData.length > 0) {
            document.getElementById('btnProcess').disabled = false;
        }
    }

    // --- 4. LOGIC PENCOCOKAN ---
    function processData() {
        // A. Buat Index Data Customer (Grouping by Vendor Invoice No)
        let customerMap = {};
        
        customerData.forEach(row => {
            // Pastikan menggunakan nama kolom yang sudah dibersihkan (tanpa quotes)
            let invKey = row['Vendor Invoice No']; 
            let totalNet = parseFloat(row['Total Net']);
            
            if(isNaN(totalNet)) totalNet = 0;

            if(invKey) {
                invKey = invKey.trim();
                if(customerMap[invKey]) {
                    customerMap[invKey] += totalNet;
                } else {
                    customerMap[invKey] = totalNet;
                }
            }
        });

        // B. Loop Data Supplier
        finalResult = supplierData.map(sup => {
            let invNo = sup['Invoice No'] ? sup['Invoice No'].trim() : "N/A";
            let outstanding = parseFloat(sup['Outstanding']);
            if(isNaN(outstanding)) outstanding = 0;

            // Logic Match
            let custNet = 0;
            let status = "‚ùå";
            
            if(customerMap.hasOwnProperty(invNo)) {
                status = "‚úÖ";
                custNet = customerMap[invNo];
            }

            // Logic Selisih
            let selisih = outstanding - custNet;

            // Return baris baru
            return {
                ...sup,
                'Total Net Customer': custNet,
                'Selisih': selisih,
                'Status': status
            };
        });

        renderTable(finalResult);
        document.getElementById('btnExport').classList.remove('hidden');
    }

    // --- 5. RENDER TABLE ---
    function renderTable(data) {
        if(data.length === 0) return;
        
        const thead = document.querySelector('#resultTable thead');
        const tbody = document.querySelector('#resultTable tbody');
        thead.innerHTML = "";
        tbody.innerHTML = "";

        // Tentukan urutan kolom
        // Ambil semua kolom supplier, lalu tambah 3 kolom hasil di akhir
        let keys = Object.keys(data[0]).filter(k => k !== 'Status' && k !== 'Selisih' && k !== 'Total Net Customer');
        keys.push('Total Net Customer', 'Selisih', 'Status'); // Urutan custom di kanan

        // Header
        let trH = document.createElement('tr');
        keys.forEach(k => {
            let th = document.createElement('th');
            th.innerText = k;
            trH.appendChild(th);
        });
        thead.appendChild(trH);

        // Body (Limit 500 rows for performance)
        data.slice(0, 500).forEach(row => {
            let tr = document.createElement('tr');
            keys.forEach(k => {
                let td = document.createElement('td');
                let val = row[k];

                if(k === 'Status') {
                    td
