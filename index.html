<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Invoice Tracker</title>
    
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Memuat React & Babel untuk menjalankan JSX di browser -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Memuat Lucide Icons -->
    <script src="https://unpkg.com/lucide-react@latest/dist/lucide-react.js"></script>
    
    <!-- Style untuk tabel responsif di perangkat mobile -->
    <style>
        @media (max-width: 767px) {
            .responsive-table thead { display: none; }
            .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
            .responsive-row { margin-bottom: 1rem; border: 1px solid #374151; border-radius: 0.5rem; padding: 0.5rem; display: block; }
            .responsive-table td { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0.5rem; text-align: right; border-bottom: 1px solid #374151; }
            .responsive-row td:last-child { border-bottom: none; }
            .responsive-table td::before { content: attr(data-label); font-weight: 600; text-align: left; margin-right: 1rem; color: #9ca3af; }
        }
    </style>
</head>
<body class="bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const checkDependencies = () => {
            if (window.React && window.ReactDOM && window.Babel && window.lucide) {
                renderApp();
            } else {
                setTimeout(checkDependencies, 100);
            }
        };

        const renderApp = () => {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            
            // --- Semua logika aplikasi dimulai di sini ---
            const { useState, useEffect, useMemo, useRef } = React;

            const { FileText, Filter, LogOut, Loader, AlertCircle, CheckCircle, Search, LayoutDashboard, BarChart3, X, Briefcase, Building, Truck, Users } = lucide;

            // ====================================================================
            // GANTI URL DI BAWAH INI DENGAN URL WEB APP DARI GOOGLE APPS SCRIPT ANDA
            // ====================================================================
            const GOOGLE_SHEET_API_URL = "MASUKKAN_URL_API_ANDA_DI_SINI";
            
            const DATA_MASTER_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6ZfMabq_GxYJdxEytBTEhYeO9jHeOq_KQ6Eci7RJgzhY3ms03NFRBigw8Boo9weCuXG3628oiBgap/pub?gid=0&single=true&output=csv';
            const ROLE_MODEL_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS6ZfMabq_GxYJdxEytBTEhYeO9jHeOq_KQ6Eci7RJgzhY3ms03NFRBigw8Boo9weCuXG3628oiBgap/pub?gid=183358633&single=true&output=csv';

            const LOKASI_OPTIONS = ['Kantor', 'Toko', 'Sales', 'Kolektor'];
            const LOKASI_COLORS = {
                Kantor: 'border-blue-500 focus:border-blue-500 focus:ring-blue-500 text-blue-300',
                Toko: 'border-green-500 focus:border-green-500 focus:ring-green-500 text-green-300',
                Sales: 'border-orange-500 focus:border-orange-500 focus:ring-orange-500 text-orange-300',
                Kolektor: 'border-purple-500 focus:border-purple-500 focus:ring-purple-500 text-purple-300',
                '': 'border-gray-600 focus:border-blue-500 focus:ring-blue-500'
            };
            const LOKASI_ICONS = {
                Kantor: <Briefcase className="w-5 h-5" />,
                Toko: <Building className="w-5 h-5" />,
                Sales: <Truck className="w-5 h-5" />,
                Kolektor: <Users className="w-5 h-5" />
            };

            const Papa = {
                parse: (csvString, options) => {
                    const { header } = options;
                    if (!csvString) return { data: [] };
                    const lines = csvString.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const data = lines.slice(1).map(line => {
                        const values = line.split(',').map(v => v.trim());
                        if (header) { const obj = {}; headers.forEach((h, i) => { obj[h] = values[i] || ''; }); return obj; }
                        return values;
                    });
                    return { data };
                }
            };

            const formatCurrency = (value) => {
                const num = Number(String(value).replace(/[^0-9.-]+/g,""));
                if (isNaN(num)) return value;
                return new Intl.NumberFormat('id-ID').format(num);
            };

            const LoginScreen = ({ onLoginSuccess, onLoginError }) => {
                const [cabangList, setCabangList] = useState([]);
                const [roles, setRoles] = useState([]);
                const [selectedCabang, setSelectedCabang] = useState('');
                const [pin, setPin] = useState('');
                const [isLoading, setIsLoading] = useState(true);
                const [error, setError] = useState('');
                useEffect(() => {
                    const fetchRoles = async () => {
                        setIsLoading(true); setError('');
                        try {
                            const response = await fetch(ROLE_MODEL_URL);
                            if (!response.ok) throw new Error(`Gagal memuat data peran`);
                            const csvText = await response.text();
                            const parsedData = Papa.parse(csvText, { header: true }).data;
                            const validRoles = parsedData.filter(role => role.cabang && role.cabang.trim() !== '');
                            setRoles(validRoles);
                            const uniqueCabang = [...new Set(validRoles.map(role => role.cabang))];
                            setCabangList(uniqueCabang);
                            if (uniqueCabang.length > 0) setSelectedCabang(uniqueCabang[0]);
                        } catch (e) { setError('Tidak dapat mengambil data peran.'); onLoginError('Tidak dapat mengambil data peran.'); } 
                        finally { setIsLoading(false); }
                    };
                    fetchRoles();
                }, [onLoginError]);
                const handleLogin = (e) => {
                    e.preventDefault(); setError('');
                    const role = roles.find(r => r.cabang === selectedCabang);
                    if (role && String(role.pin).trim() === String(pin).trim()) { onLoginSuccess(selectedCabang); } 
                    else { const newError = 'Cabang atau PIN tidak valid.'; setError(newError); onLoginError(newError); }
                };
                return (<div className="flex items-center justify-center min-h-screen bg-gray-900 font-sans text-gray-200"><div className="w-full max-w-sm p-8 space-y-6 bg-gray-800 border border-gray-700 rounded-xl shadow-2xl shadow-blue-500/10"><div className="text-center"><h1 className="text-3xl font-bold text-white">Invoice Tracker</h1><p className="text-gray-400 mt-2">Silakan login untuk melanjutkan</p></div>{error && (<div className="p-3 text-red-300 bg-red-900/50 border border-red-500/30 rounded-lg flex items-center"><AlertCircle className="w-5 h-5 mr-2" /><span>{error}</span></div>)}<form onSubmit={handleLogin} className="space-y-6"><div><label htmlFor="cabang" className="block text-sm font-medium text-gray-400">Cabang</label><select id="cabang" value={selectedCabang} onChange={(e) => setSelectedCabang(e.target.value)} disabled={isLoading} className="w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{isLoading ? <option>Memuat cabang...</option> : cabangList.map(c => <option key={c} value={c}>{c}</option>)}</select></div><div><label htmlFor="pin" className="block text-sm font-medium text-gray-400">PIN</label><input type="password" id="pin" value={pin} onChange={(e) => setPin(e.target.value)} placeholder="••••••" className="w-full px-3 py-2 mt-1 text-white bg-gray-700 border border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required /></div><div><button type="submit" disabled={isLoading} className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 disabled:bg-gray-500 flex items-center justify-center transition-all duration-300">{isLoading && <Loader className="w-5 h-5 mr-2 animate-spin" />} Login</button></div></form></div></div>);
            };
            
            const EditableTableRow = ({ item, onSave, loggedInCabang }) => {
                const [lokasi, setLokasi] = useState(item['lokasi invoice'] || '');
                const [tanggalTerima, setTanggalTerima] = useState(item['tanggal tanda terima'] || '');
                const [saveStatus, setSaveStatus] = useState('idle');
                const isInitialMount = useRef(true);
                useEffect(() => { setLokasi(item['lokasi invoice'] || ''); setTanggalTerima(item['tanggal tanda terima'] || ''); }, [item]);
                useEffect(() => {
                    if (isInitialMount.current) { isInitialMount.current = false; return; }
                    const handler = setTimeout(() => {
                        setSaveStatus('saving');
                        const dataToSave = { ...item, 'lokasi invoice': lokasi, 'tanggal tanda terima': tanggalTerima, 'diperbarui oleh': loggedInCabang };
                        onSave(dataToSave).then(success => { setSaveStatus(success ? 'success' : 'error'); setTimeout(() => setSaveStatus('idle'), 2000); });
                    }, 800);
                    return () => clearTimeout(handler);
                }, [lokasi, tanggalTerima]);
                const StatusIndicator = () => {
                    switch (saveStatus) {
                        case 'saving': return <Loader className="w-4 h-4 text-blue-400 animate-spin" />;
                        case 'success': return <CheckCircle className="w-4 h-4 text-green-500" />;
                        case 'error': return <AlertCircle className="w-4 h-4 text-red-500" />;
                        default: return <div className="w-4 h-4" />;
                    }
                };
                const selectColorClass = LOKASI_COLORS[lokasi] || LOKASI_COLORS[''];
                return (<tr className="responsive-row bg-gray-800 hover:bg-gray-700/60"><td data-label="Invoice" className="font-medium text-white"><div className="flex justify-between items-center w-full">{item.invoice}<div className="md:hidden"><StatusIndicator /></div></div></td><td data-label="Tanggal">{item.tanggal}</td><td data-label="Pelanggan">{item.pelanggan}</td><td data-label="Original Value" className="text-right">{formatCurrency(item['original value'])}</td><td data-label="Lokasi Invoice"><select value={lokasi} onChange={(e) => setLokasi(e.target.value)} className={`w-full p-2 text-sm text-white bg-gray-700 rounded-md focus:ring-1 transition-colors duration-300 ${selectColorClass}`}><option value="" disabled>Pilih Lokasi</option>{LOKASI_OPTIONS.map(opt => <option key={opt} value={opt} className="bg-gray-800 text-white">{opt}</option>)}</select></td><td data-label="Tgl Tanda Terima"><input type="date" value={tanggalTerima} onChange={(e) => setTanggalTerima(e.target.value)} className="w-full p-2 text-sm text-white bg-gray-700 border border-gray-600 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500"/></td><td className="hidden md:table-cell text-center align-middle w-12"><StatusIndicator /></td></tr>);
            };

            const InfoModal = ({ isOpen, onClose, title, data }) => {
                if (!isOpen) return null;
                return (<div className="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onClick={onClose}><div className="bg-gray-800 border border-gray-700 rounded-lg shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col" onClick={e => e.stopPropagation()}><header className="flex items-center justify-between p-4 border-b border-gray-700"><h2 className="text-lg font-semibold text-white">{title}</h2><button onClick={onClose} className="text-gray-400 hover:text-white"><X className="w-6 h-6" /></button></header><div className="p-6 overflow-y-auto"><table className="w-full text-left"><thead className="bg-gray-700"><tr><th className="px-4 py-2 text-sm font-semibold text-gray-300">Invoice</th><th className="px-4 py-2 text-sm font-semibold text-gray-300">Tanggal</th><th className="px-4 py-2 text-sm font-semibold text-gray-300">Pelanggan</th><th className="px-4 py-2 text-sm font-semibold text-gray-300 text-right">Original Value</th></tr></thead><tbody>{data.map(item => (<tr key={item.invoice} className="border-b border-gray-700"><td className="px-4 py-2 text-sm text-gray-300">{item.invoice}</td><td className="px-4 py-2 text-sm text-gray-400">{item.tanggal}</td><td className="px-4 py-2 text-sm text-gray-300">{item.pelanggan}</td><td className="px-4 py-2 text-sm text-gray-300 text-right">{formatCurrency(item['original value'])}</td></tr>))}</tbody></table></div></div></div>);
            };
            
            const SimpleBarChart = ({ data, keys, colors, onBarClick }) => {
                const chartHeight = 350; const chartWidth = 700;
                const padding = { top: 20, right: 20, bottom: 60, left: 40 };
                const maxValue = useMemo(() => Math.max(...data.map(d => keys.reduce((sum, key) => sum + (d[key] || 0), 0)), 10), [data, keys]);
                const yAxisLabels = useMemo(() => Array.from({ length: 6 }, (_, i) => Math.round(i * maxValue / 5)), [maxValue]);
                const Bar = ({ d, barIndex }) => {
                    let currentHeight = 0; const barWidth = Math.max((chartWidth - padding.left - padding.right) / data.length * 0.6, 20);
                    const total = keys.reduce((sum, key) => sum + (d[key] || 0), 0);
                    return (<g transform={`translate(${padding.left + ((chartWidth - padding.left - padding.right) / data.length) * (barIndex + 0.5) - barWidth / 2}, 0)`}>{keys.map(key => {if (!d[key]) return null; const height = (d[key] / maxValue) * (chartHeight - padding.top - padding.bottom); const y = chartHeight - padding.bottom - height - currentHeight; currentHeight += height; return (<g key={key} onClick={() => onBarClick(d.name, key)} className="cursor-pointer group"><defs><linearGradient id={`gradient-${key}`} x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" stopColor={colors[key]} stopOpacity="1" /><stop offset="100%" stopColor={colors[key]} stopOpacity="0.5" /></linearGradient></defs><rect y={y} width={barWidth} height={height} fill={`url(#gradient-${key})`} className="transition-all duration-300 group-hover:opacity-75" />{height > 20 && <text x={barWidth/2} y={y + height/2 + 4} textAnchor="middle" className="text-xs font-bold fill-current text-white pointer-events-none">{d[key]}</text>}</g>);})}<text x={barWidth / 2} y={chartHeight - padding.bottom + 15} textAnchor="middle" className="text-sm font-bold fill-current text-white">{total}</text><text x={barWidth / 2} y={chartHeight - padding.bottom + 35} textAnchor="middle" className="text-xs fill-current text-gray-400">{d.name}</text></g>);
                };
                return (<div className="relative w-full overflow-x-auto"><svg viewBox={`0 0 ${chartWidth} ${chartHeight}`} className="font-sans min-w-[600px]">{yAxisLabels.map(label => {const y = chartHeight - padding.bottom - (label / maxValue) * (chartHeight - padding.top - padding.bottom); return (<g key={label} className="text-gray-600"><line x1={padding.left} x2={chartWidth - padding.right} y1={y} y2={y} stroke="currentColor" strokeDasharray="2,2" /><text x={padding.left - 8} y={y + 4} textAnchor="end" className="text-xs fill-current text-gray-500">{label}</text></g>);})}{data.map((d, i) => <Bar key={d.name} d={d} barIndex={i} />)}</svg></div>)
            }
            
            const Dashboard = ({ data, onBarClick }) => {
                const chartKeys = LOKASI_OPTIONS;
                const chartData = useMemo(() => {
                    if (!data || data.length === 0) return [];
                    const counts = data.reduce((acc, curr) => {const cabang = curr.cabang || 'Lainnya'; const lokasi = curr['lokasi invoice']; if (!chartKeys.includes(lokasi)) return acc; if (!acc[cabang]) { acc[cabang] = { name: cabang }; chartKeys.forEach(key => acc[cabang][key] = 0); } if (acc[cabang][lokasi] !== undefined) acc[cabang][lokasi]++; return acc;}, {});
                    return Object.values(counts);
                }, [data]);
                const colors = { Kantor: "#3b82f6", Toko: "#22c55e", Sales: "#f97316", Kolektor: "#8b5cf6" };
                return (<div className="p-4 sm:p-6"><header className="flex flex-col sm:flex-row items-center justify-between mb-6 gap-4"><div className="flex items-center"><BarChart3 className="w-8 h-8 text-blue-400" /><h1 className="text-xl sm:text-2xl font-bold text-white ml-3">Dashboard Jumlah Invoice</h1></div><div className="flex flex-wrap justify-center sm:justify-end gap-x-4 gap-y-2">{Object.entries(colors).map(([name, color]) => (<div key={name} className="flex items-center"><div className="w-3 h-3 rounded-sm mr-2" style={{ backgroundColor: color }}></div><span className="text-xs text-gray-400">{name}</span></div>))}</div></header><div className="bg-gray-800/50 border border-gray-700 p-2 sm:p-4 rounded-lg shadow-md">{chartData.length > 0 ? (<SimpleBarChart data={chartData} keys={chartKeys} colors={colors} onBarClick={onBarClick} />) : (<div className="flex items-center justify-center h-64 text-gray-500">Data tidak cukup untuk menampilkan chart.</div>)}</div></div>);
            };

            const GlobalSummary = ({ data }) => {
                const summary = useMemo(() => {
                    const initial = { total: 0 };
                    LOKASI_OPTIONS.forEach(opt => initial[opt] = 0);
                    return data.reduce((acc, item) => {
                        acc.total++;
                        if(LOKASI_OPTIONS.includes(item['lokasi invoice'])) {
                            acc[item['lokasi invoice']]++;
                        }
                        return acc;
                    }, initial);
                }, [data]);
                return (<div className="px-4 sm:px-6 py-4 bg-gray-800/50 border-b border-gray-700"><h2 className="text-sm font-semibold text-gray-400 mb-3">Ringkasan Global</h2><div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4"><div className="bg-gray-700/50 p-3 rounded-lg text-center"><p className="text-2xl font-bold text-white">{summary.total}</p><p className="text-xs text-gray-400">Total Invoice</p></div>{LOKASI_OPTIONS.map(opt => (<div key={opt} className="bg-gray-700/50 p-3 rounded-lg text-center"><p className={`text-2xl font-bold ${LOKASI_COLORS[opt]}`}>{summary[opt]}</p><p className="text-xs text-gray-400">{opt}</p></div>))}</div></div>);
            }

            const SlicerSummary = ({ data }) => {
                const summary = useMemo(() => {
                    const initial = {};
                    LOKASI_OPTIONS.forEach(opt => initial[opt] = 0);
                    return data.reduce((acc, item) => {
                        if(LOKASI_OPTIONS.includes(item['lokasi invoice'])) {
                            acc[item['lokasi invoice']]++;
                        }
                        return acc;
                    }, initial);
                }, [data]);
                return (<div className="w-full flex flex-wrap items-center justify-center gap-2 sm:gap-4">{LOKASI_OPTIONS.map(opt => (<div key={opt} className={`flex items-center gap-2 p-2 rounded-md bg-gray-700/50 border border-gray-600/50`}><div className={LOKASI_COLORS[opt]}>{LOKASI_ICONS[opt]}</div><span className="text-white font-semibold">{summary[opt]}</span></div>))}</div>);
            };

            const MainApp = ({ loggedInCabang, onLogout }) => {
                const [masterData, setMasterData] = useState([]);
                const [filteredData, setFilteredData] = useState([]);
                const [cabangList, setCabangList] = useState([]);
                const [activeFilter, setActiveFilter] = useState('');
                const [isLoading, setIsLoading] = useState(true);
                const [error, setError] = useState('');
                const [searchQuery, setSearchQuery] = useState('');
                const [currentView, setCurrentView] = useState('table');
                const [modalState, setModalState] = useState({ isOpen: false, title: '', data: [] });

                const hasSlicerAccess = useMemo(() => ['pusat', 'admin', 'jkt'].includes(loggedInCabang.toLowerCase()), [loggedInCabang]);
                const isJKT = useMemo(() => loggedInCabang.toLowerCase() === 'jkt', [loggedInCabang]);

                useEffect(() => {
                    const fetchAndMergeData = async () => {
                        setIsLoading(true); setError('');
                        try {
                            const [apiResponse, csvResponse] = await Promise.all([fetch(GOOGLE_SHEET_API_URL), fetch(DATA_MASTER_CSV_URL)]);
                            if (!apiResponse.ok) throw new Error(`Gagal memuat data API`);
                            if (!csvResponse.ok) throw new Error(`Gagal memuat data master CSV`);
                            const apiResult = await apiResponse.json();
                            const csvText = await csvResponse.text();
                            if (apiResult.status !== 'success') throw new Error(apiResult.message || 'Gagal memuat data API');
                            
                            const apiData = apiResult.data;
                            const masterDataFromCsv = Papa.parse(csvText, { header: true }).data.filter(d => d.invoice);
                            const apiDataMap = new Map(apiData.map(item => [item.invoice, item]));
                            const mergedData = masterDataFromCsv.map(csvItem => {
                                const apiItem = apiDataMap.get(csvItem.invoice);
                                return apiItem ? { ...csvItem, 'lokasi invoice': apiItem['lokasi invoice'] || '', 'tanggal tanda terima': apiItem['tanggal tanda terima'] || '' } : csvItem;
                            });
                            setMasterData(mergedData);
                            setCabangList([...new Set(mergedData.map(item => item.cabang).filter(Boolean))]);
                            setActiveFilter(hasSlicerAccess ? 'Semua' : loggedInCabang);
                        } catch (e) { setError(e.message); } 
                        finally { setIsLoading(false); }
                    };
                    fetchAndMergeData();
                }, [loggedInCabang, hasSlicerAccess]);

                useEffect(() => {
                    let data = masterData;
                    if (hasSlicerAccess && activeFilter !== 'Semua') { data = data.filter(item => item.cabang === activeFilter); } 
                    else if (!hasSlicerAccess) { data = data.filter(item => item.cabang === loggedInCabang); }
                    if (searchQuery) {
                        const lq = searchQuery.toLowerCase();
                        data = data.filter(item => (item.invoice?.toLowerCase().includes(lq)) || (item.pelanggan?.toLowerCase().includes(lq)));
                    }
                    setFilteredData(data);
                }, [masterData, activeFilter, loggedInCabang, searchQuery, hasSlicerAccess]);
                
                const handleSave = async (updatedRow) => {
                    try {
                        await fetch(GOOGLE_SHEET_API_URL, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'update', invoice: updatedRow.invoice, data: updatedRow }) });
                        setMasterData(prev => prev.map(item => item.invoice === updatedRow.invoice ? updatedRow : item));
                        return true;
                    } catch (error) { console.error("Error saving data:", error); return false; }
                };
                
                const handleBarClick = (cabang, lokasi) => {
                    const modalData = masterData.filter(item => item.cabang === cabang && item['lokasi invoice'] === lokasi);
                    setModalState({ isOpen: true, title: `Detail Invoice - ${lokasi} (${cabang})`, data: modalData });
                };

                return (<><InfoModal isOpen={modalState.isOpen} onClose={() => setModalState({ ...modalState, isOpen: false })} title={modalState.title} data={modalState.data} /><div className="min-h-screen bg-gray-900 text-gray-300 font-sans"><div className="max-w-7xl mx-auto bg-gray-800 border-x border-gray-700/50 min-h-screen">
                    <GlobalSummary data={masterData} />
                    {isJKT && (<nav className="bg-gray-800/70 border-b border-gray-700 px-2 sm:px-6 flex items-center justify-between backdrop-blur-sm sticky top-0 z-10"><div className="flex items-center"><button onClick={() => setCurrentView('table')} className={`relative flex items-center px-3 sm:px-4 py-3 text-sm font-medium transition-colors duration-300 ${currentView === 'table' ? 'text-white' : 'text-gray-400 hover:text-white'}`}><FileText className="w-5 h-5 mr-2"/><span className="hidden sm:inline">Data Invoice</span>{currentView === 'table' && <span className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></span>}</button><button onClick={() => setCurrentView('dashboard')} className={`relative flex items-center px-3 sm:px-4 py-3 text-sm font-medium transition-colors duration-300 ${currentView === 'dashboard' ? 'text-white' : 'text-gray-400 hover:text-white'}`}><LayoutDashboard className="w-5 h-5 mr-2"/><span className="hidden sm:inline">Dashboard</span>{currentView === 'dashboard' && <span className="absolute bottom-0 left-0 w-full h-0.5 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"></span>}</button></div><button onClick={onLogout} className="flex items-center px-3 py-1.5 sm:px-4 sm:py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"><LogOut className="w-4 h-4 sm:mr-2" /><span className="hidden sm:inline">Logout</span></button></nav>)}
                    {currentView === 'table' && (<div className="p-4 sm:p-6">
                        <header className="flex flex-col lg:flex-row items-center justify-between mb-6 gap-4">
                            <div className="relative w-full lg:w-72"><Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-500" /><input type="text" placeholder="Cari Invoice atau Pelanggan..." value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} className="w-full pl-10 pr-4 py-2 bg-gray-700 text-white border border-gray-600 rounded-md" /></div>
                            <SlicerSummary data={filteredData}/>
                            <div className="flex items-center space-x-4 w-full lg:w-auto justify-end">{hasSlicerAccess && (<div className="flex items-center space-x-2 flex-grow sm:flex-grow-0"><Filter className="w-5 h-5 text-gray-400" /><select value={activeFilter} onChange={(e) => setActiveFilter(e.target.value)} className="w-full p-2 bg-gray-700 text-white border border-gray-600 rounded-md"><option value="Semua">Semua Cabang</option>{cabangList.map(c => <option key={c} value={c}>{c}</option>)}</select></div>)}{!isJKT && (<button onClick={onLogout} className="flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700"><LogOut className="w-4 h-4 mr-2" />Logout</button>)}</div>
                        </header>
                        {error && <div className="p-4 mb-4 text-red-300 bg-red-900/50 rounded-lg">{error}</div>}
                        <div className="overflow-x-auto">{isLoading ? (<div className="flex justify-center items-center p-20"><Loader className="w-10 h-10 text-blue-400 animate-spin" /><span className="ml-4 text-gray-400">Memuat data...</span></div>) : (<table className="w-full min-w-[700px] text-left text-gray-400 responsive-table"><thead><tr className="bg-gradient-to-r from-blue-900 via-blue-800 to-gray-800"><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50">Invoice</th><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50">Tanggal</th><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50">Pelanggan</th><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50 text-right">Original Value</th><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50">Lokasi Invoice</th><th className="p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50">Tgl Tanda Terima</th><th className="w-12 p-4 text-sm font-semibold text-white border-b-2 border-blue-700/50"></th></tr></thead><tbody>{filteredData.length > 0 ? (filteredData.map(item => <EditableTableRow key={item.invoice} item={item} onSave={handleSave} loggedInCabang={loggedInCabang}/>)) : (<tr><td colSpan="7" className="text-center py-16 text-gray-500">Tidak ada data untuk ditampilkan.</td></tr>)}</tbody></table>)}</div>
                    </div>)}
                    {currentView === 'dashboard' && <Dashboard data={masterData} onBarClick={handleBarClick} />}
                </div></div></>);
            };

            const App = () => {
                const [isLoggedIn, setIsLoggedIn] = useState(false);
                const [loggedInCabang, setLoggedInCabang] = useState(null);
                const [loginError, setLoginError] = useState('');
                
                const handleLoginSuccess = (cabang) => { setIsLoggedIn(true); setLoggedInCabang(cabang); setLoginError(''); };
                const handleLogout = () => { setIsLoggedIn(false); setLoggedInCabang(null); };

                return (<>{isLoggedIn ? (<MainApp loggedInCabang={loggedInCabang} onLogout={handleLogout} />) : (<LoginScreen onLoginSuccess={handleLoginSuccess} onLoginError={setLoginError} />)}</>);
            }
            
            root.render(<App />);
        };

        checkDependencies();
    </script>
</body>
</html>
